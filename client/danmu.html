<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Danmaku</title>
</head>
<body>

<div class="screen_container" id="contents">
</div>

<div class="main">
    <textarea id="danmakutext" type="text" placeholder="Danmaku~"></textarea>
    <button class="send">Send</button>
</div>
<style>
    .screen_container {
        position: relative;
        width: 800px;
        height: 400px;
        margin: 30px auto;
        background: #000;
        overflow: hidden;
        border-style: solid;
        border-radius: 25px;
        border-color: deeppink;
    }

    .main {
        width: 600px;
        margin: 20px auto;
        text-align: center;
    }
</style>
<!-- jQuery -->
<script src="https://cdn.staticfile.org/jquery/3.3.1/jquery.min.js"></script>
<script>
    const id = generateId(32); // every html has its own id which is used to recognise it
    const url = window.location.href;
    const timers = [];
    const jqueryDom = createDanmaku('hihihi'); // test danmaku, delete it as you like
    addInterval(jqueryDom);// test danmaku, delete it as you like

    console.log(encodeURI("asdufoiausdhfila823541234"))
    decodeURI()

    // ask whether there is a new danmaku every 1s
    addDanmaku();
    function addDanmaku() {
        fetch(url + '?newdanmaku', {
            method: 'get',
            headers: {
                'Id': id
            }
        }).then(response => response.text())
        .then(text => {
            if (!text.includes('404 Not Found')) {// if there are new danmakus
                var danmakus = text.split('\r')
                for (let i = 0; i < danmakus.length; i++) {
                    if (danmakus[i] !== '\n' || danmakus[i] !== '') addInterval(createDanmaku(decodeURI(danmakus[i])));
                }
            }
            setTimeout(addDanmaku, 1000)//ask for new danmaku every 1s
        });
    }

    $(".send").on("click", function () {
        const danmu = document.getElementById('danmakutext').value;
        if (danmu.length > 0) {
            fetch(url, {
                method: 'post',
                headers: {
                    'Danmu': encodeURI(danmu),

                    'Id': id
                },
            })
        }
    });

    // create a Dom object corresponding to a danmaku
    function createDanmaku(text) {
        const jqueryDom = $("<div class='bullet'>" + text + "</div>");
        const fontColor = "rgb(255,255,255)";
        const fontSize = "20px";
        let top = Math.floor(Math.random() * 400) + "px";
        const left = $(".screen_container").width() + "px";
        jqueryDom.css({
            "position": 'absolute',
            "color": fontColor,
            "font-size": fontSize,
            "left": left,
            "top": top,
        });
        $(".screen_container").append(jqueryDom);
        return jqueryDom;
    }

    // add timer task to let the danmaku fly from right to left
    function addInterval(jqueryDom) {
        let left = jqueryDom.offset().left - $(".screen_container").offset().left;
        const timer = setInterval(function () {
            left--;
            jqueryDom.css("left", left + "px");
            if (jqueryDom.offset().left + jqueryDom.width() < $(".screen_container").offset().left) {
                jqueryDom.remove();
                clearInterval(timer);
            }
        }, 5); // set delay as 5ms,which means the danmaku changes its position every 5ms
        timers.push(timer);
    }

    // generate a random code
    function generateId(length) {
        if (length > 0) {
            var alphabet = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"];
            var id = "";
            for (var i = 0; i < length; i++) {
                var r = parseInt(Math.random() * 61);
                id += alphabet[r];
            }
            return id;
        } else {
            return false;
        }
    }
</script>
</body>

</html>